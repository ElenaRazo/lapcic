
@{
    ViewBag.Title = "TipoPago";
    Layout = null;
}
<script src="~/Scripts/jquery-1.10.2.min.js"></script>
<div class="m-portlet m-portlet--full-height m-portlet--tabs  ">
    <div class="m-portlet__head" style="background-color:#0b9dd1">
        <div class="m-portlet__head-tools">
            <ul class="nav nav-tabs m-tabs m-tabs-line   m-tabs-line--left m-tabs-line--primary" role="tablist">
                <li class="nav-item m-tabs__item">
                    <a class="nav-link m-tabs__link active" data-toggle="tab" href="#m_user_profile_tab_1" role="tab">
                        <i class="flaticon-share m--hide"></i>
                        Datos Generales
                    </a>
                </li>
                <li class="nav-item m-tabs__item">
                    <a class="nav-link m-tabs__link " data-toggle="tab" href="#m_user_profile_tab_2" role="tab">
                        <i class="flaticon-share m--hide"></i>
                       Agregar Estudios
                    </a>
                </li>
            </ul>
        </div>
        <div class="m-portlet__head-tools">
        </div>
    </div>
    <div class="tab-content">
        <div class="tab-pane active" id="m_user_profile_tab_1">
            <form class="m-form m-form--fit m-form--label-align-right" id="generalesSolicitud">
                <div class="m-portlet__body" style="height:inherit;padding:2.2rem">
                    <div class="m-alert m-alert--icon alert alert-danger m--hide" role="alert" id="m_form_1_msg">
                        <div class="m-alert__icon">
                            <i class="la la-warning"></i>
                        </div>
                        <div class="m-alert__text">
                            Los campos marcados son requeridos, revise y vuelva a intentar.
                        </div>
                        <div class="m-alert__close">
                            <button type="button" class="close" data-close="alert" aria-label="Close"></button>
                        </div>
                    </div>
                    <div class="form-group m-form__group row">
                        <label class="col-form-label col-lg-2 col-sm-12">
                            Clave
                            <span class="required" aria-required="true"> * </span>
                        </label>
                        <div class="col-lg-4 col-md-10 col-sm-12">
                            <input type="text" id="claveSolicitud" disabled="disabled" class="form-control" name="clave" aria-required="true" aria-invalid="false">
                        </div>
                    </div>
                    <div class="form-group m-form__group row">
                        <label class="col-form-label col-lg-2 col-sm-12">
                            Paciente
                            <span class="required" aria-required="true"> * </span>
                        </label>
                        <div class="col-lg-10 col-md-10 col-sm-12">
                            <input id="textPaciente" class="form-control m-input" type="text" onchange="javascript:SearchPaciente()" />
                            <select id="PacientesNuevo" class="form-control m-input" ondblclick="unexpand(this); $(this).css('background-color','#ffeb00')" onFocus="expand(this);$(this).css('background-color','white')" onBlur="unexpand(this)"></select>
                            <a onclick="javacript:Editar()" class="btn btn-secondary m-btn m-btn--air m-btn--custom">Editar</a>
                            <a onclick="javascript:$('#nuevoPaciente').show();$('#generalesSolicitud').hide();" class="btn btn-secondary m-btn m-btn--air m-btn--custom">+</a>
                            <span class="" dir="ltr" style="width: auto;"><span class="selection"><span class="select2-selection select2-selection--single" role="combobox" aria-haspopup="true" aria-expanded="false" tabindex="0" aria-labelledby="select2-puesto_list-container"><span class="select2-selection__rendered" id="select2-puesto_list-container"><span class="select2-selection__placeholder">Selecciona el paciente</span></span><span class="select2-selection__arrow" role="presentation"><b role="presentation"></b></span></span></span><span class="dropdown-wrapper" aria-hidden="true"></span></span>
                        </div>
                    </div>
                    <div class="form-group m-form__group row">
                        <label class="col-form-label col-lg-2 col-sm-12">
                            Médicos
                            <span class="required" aria-required="true"> * </span>
                        </label>
                        <div class="col-lg-10 col-md-10 col-sm-12">
                            <input id="txtMedico" class="form-control m-input" type="text" onchange="javascript:SearchTextMedico()" />
                            <select id="Medicos" class="form-control m-input" ondblclick="unexpand(this); $(this).css('background-color','#ffeb00')" onFocus="expand(this);$(this).css('background-color','white')" onBlur="unexpand(this)"></select>
                            <a onclick="javascript:$('#nuevoMedico').show();$('#generalesSolicitud').hide();" class="btn btn-secondary m-btn m-btn--air m-btn--custom">+</a>
                            <span class="" dir="ltr" style="width: auto;"><span class="selection"><span class="select2-selection select2-selection--single" role="combobox" aria-haspopup="true" aria-expanded="false" tabindex="0" aria-labelledby="select2-puesto_list-container"><span class="select2-selection__rendered" id="select2-puesto_list-container"><span class="select2-selection__placeholder">Selecciona el médico</span></span><span class="select2-selection__arrow" role="presentation"><b role="presentation"></b></span></span></span><span class="dropdown-wrapper" aria-hidden="true"></span></span>
                        </div>
                    </div>
                    <div class="form-group m-form__group row">
                        <label class="col-form-label col-lg-2 col-sm-12">
                            Empresa
                            <span class="required" aria-required="true"> * </span>
                        </label>
                        <div class="col-lg-10 col-md-10 col-sm-12">
                            @Html.DropDownList("Empresas", null, new { @class = "form-control m-input", @id = "Empresas", @name = "Empresas", @tabindex = "-1" })
                            <span class="" dir="ltr" style="width: auto;"><span class="selection"><span class="select2-selection select2-selection--single" role="combobox" aria-haspopup="true" aria-expanded="false" tabindex="0" aria-labelledby="select2-puesto_list-container"><span class="select2-selection__rendered" id="select2-puesto_list-container"><span class="select2-selection__placeholder">Selecciona la empresa</span></span><span class="select2-selection__arrow" role="presentation"><b role="presentation"></b></span></span></span><span class="dropdown-wrapper" aria-hidden="true"></span></span>
                        </div>
                    </div>
                    <div class="form-group m-form__group row">
                        <label class="col-form-label col-lg-2 col-sm-12">
                            Pase médico o documento
                            <span class="required" aria-required="true"> * </span>
                        </label>
                        <div class="col-lg-4 col-md-10 col-sm-12">
                            <input type="text" id="pase" class="form-control" name="pase" aria-required="true" aria-invalid="false">
                        </div>
                    </div>
                    <div class="form-group m-form__group row">
                        <label class="col-form-label col-lg-2 col-sm-12">
                            Observaciones
                        </label>
                        <div class="col-lg-10 col-md-10 col-sm-12">
                            <textarea class="form-control m-input" rows="3" name="remarks" id="indicaciones"></textarea>
                        </div>
                    </div>
                    <div class="form-group m-form__group row">
                        <label class="col-form-label col-lg-2 col-sm-12">
                            Entrega
                            <span class="required" aria-required="true"> * </span>
                        </label>
                        <div class="col-lg-10 col-md-10 col-sm-12">
                            <select id="Urgencia" class="form-control m-input">
                                <option value="0">NORMAL</option>
                                <option value="1">DÍAS</option>
                                <option value="2">MAÑANA</option>
                                <option value="3">HOY</option>
                                <option value="4">URGENCIA</option>
                            </select>
                            <span class="" dir="ltr" style="width: auto;"><span class="selection"><span class="select2-selection select2-selection--single" role="combobox" aria-haspopup="true" aria-expanded="false" tabindex="0" aria-labelledby="select2-puesto_list-container"><span class="select2-selection__rendered" id="select2-puesto_list-container"><span class="select2-selection__placeholder">Selecciona el tipo de entrega</span></span><span class="select2-selection__arrow" role="presentation"><b role="presentation"></b></span></span></span><span class="dropdown-wrapper" aria-hidden="true"></span></span>
                        </div>
                    </div>
                    <div class="form-group m-form__group row">
                        <label class="col-form-label col-lg-2 col-sm-12">
                            Observaciones entrega
                        </label>
                        <div class="col-lg-10 col-md-10 col-sm-12">
                            <textarea class="form-control m-input" rows="3" name="remarks" id="observaciones"></textarea>
                        </div>
                    </div>
                    <div class="form-group m-form__group row">
                        <label class="col-form-label col-lg-2 col-sm-12">
                            Factura
                            <span class="required" aria-required="true"> * </span>
                        </label>
                        <div class="col-lg-10 col-md-10 col-sm-12">
                            <select id="factura" class="form-control m-input">
                                <option value="0">NO</option>
                                <option value="1">SI</option>
                            </select>
                            <span class="" dir="ltr" style="width: auto;"><span class="selection"><span class="select2-selection select2-selection--single" role="combobox" aria-haspopup="true" aria-expanded="false" tabindex="0" aria-labelledby="select2-puesto_list-container"><span class="select2-selection__rendered" id="select2-puesto_list-container"><span class="select2-selection__placeholder">Selecciona el tipo de entrega</span></span><span class="select2-selection__arrow" role="presentation"><b role="presentation"></b></span></span></span><span class="dropdown-wrapper" aria-hidden="true"></span></span>
                        </div>
                    </div>
                    <div class="form-group m-form__group row">
                        <label class="col-form-label col-lg-2 col-sm-12">
                           Datos facturación
                        </label>
                        <div class="col-lg-10 col-md-10 col-sm-12">
                            <textarea class="form-control m-input" rows="3" name="remarks" id="datosfactura"></textarea>
                        </div>
                    </div>
                </div>
            </form>
            <div id="nuevoPaciente" style="display:none;">
                @{ Html.RenderAction("Nuevo", "Pacientes"); }
            </div>
            <div id="nuevoMedico" style="display:none;">
                @{ Html.RenderAction("Nuevo", "Medicos"); }
            </div>
            <div id="editPaciente" style="display:none;">
            </div>
        </div>
        <div class="tab-pane" id="m_user_profile_tab_2" >
            <div class="col-lg-12">
                <div class="form-group m-form__group row" style="padding:2.2rem">
                    <label class="col-form-label col-lg-2 col-sm-12">
                        Estudios
                        <span class="required" aria-required="true"> * </span>
                    </label>
                    <div class="col-lg-10 col-md-10 col-sm-12">
                        <input id="txtEstudio" class="form-control m-input" type="text" onchange="javascript:SearchEstudio()" />
                        <select id="Estudios" onchange="setPrecioEstudio(this.options[this.selectedIndex].getAttribute('precio'))" class="form-control m-input" ondblclick="unexpand(this); $(this).css('background-color', '#ffeb00');Agregar()" onFocus="expand(this);$(this).css('background-color','white')" onBlur="unexpand(this)"></select><a onclick="javascript:Agregar()" class="btn btn-secondary m-btn m-btn--air m-btn--custom">Agregar</a>
                        <span class="" dir="ltr" style="width: auto;"><span class="selection"><span class="select2-selection select2-selection--single" role="combobox" aria-haspopup="true" aria-expanded="false" tabindex="0" aria-labelledby="select2-puesto_list-container"><span class="select2-selection__rendered" id="select2-puesto_list-container"><span class="select2-selection__placeholder">Selecciona el estudio</span></span><span class="select2-selection__arrow" role="presentation"><b role="presentation"></b></span></span></span><span class="dropdown-wrapper" aria-hidden="true"></span></span>
                    </div>
                </div>
                <table class="table table-striped m-table" id="tblEstudios">
                    <thead>
                        <tr style="height: 54px;">
                            <th style="width:80%"> Nombre </th>
                            <th style="width:15%"> Precio </th>
                            <th style="width:5%"></th>
                        </tr>
                    </thead>
                    <tbody id="tbodyEstudios"></tbody>
                </table>
                <div id="total" style="text-align:right; font-weight:bold;background-color: #36919d;color: white; padding:10px;">

                </div>
            </div>
            <div class="m-portlet__foot m-portlet__no-border m-portlet__foot--fit">
                <div class="m-form__actions m-form__actions--solid">
                    <div class="row">
                        <div class="col-lg-6">
                            <a class="btn btn-primary m-btn m-btn--air m-btn--custom" onclick="javasccript: Guardar()">
                                Guardar Solicitud
                            </a>
                            <a class="btn btn-secondary m-btn m-btn--air m-btn--custom">
                                Cancelar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var ddl1 = $('#PacientesNuevo');
    var ddl2 = $('#Medicos');
    var ddl3 = $('#Estudios');
    var estudios = [];
    var precioactual = 0;
    var total = 0;
    function Editar() {
        if ($('#PacientesNuevo').val() != "") {
            mApp.blockPage({
                overlayColor: '#000000',
                type: 'loader',
                state: 'success',
                message: 'Recuperando información del paciente, por favor espere...'
            });
            $.ajax({
                type: "POST",
                dataType: 'json',
                data: {

                    Id: parseInt($('#PacientesNuevo').val())
                },
                url: '@Url.Content("~/")Pacientes/DetalleSimple',
                async: true,
                success: function (response) {
                    $('#editPaciente').html(response);
                    $('#editPaciente').show();
                    $('#nuevoPaciente').hide(); $('#generalesSolicitud').hide();
                    mApp.unblockPage();
                },
                error: function (response) {
                    $('#editPaciente').html(response.responseText);
                    $('#editPaciente').show();
                    $('#nuevoPaciente').hide(); $('#generalesSolicitud').hide();
                    mApp.unblockPage();
                }
            })
        }
    }
    function Agregar() {
        if (ddl3.val() != 0) {
            $('#tbodyEstudios').html($('#tbodyEstudios').html() +
                '<tr class="estudio" clave="' + ddl3.val() + '" id="tr' + ddl3.val() + '"><td style="width:80%">' +
                $("#Estudios option:selected").text() +
                '</th><td style= "width:15%" class="precio" >' +
                precioactual +
                '</td><td style="width:5%"> <a onclick=EliminarEstudio("' + ddl3.val() + '") class="btn btn-outline btn-circle dark btn-sm black" title="Eliminar"><i class="fa fa-trash-o"></i></a></td></tr>');
            var total = 0;
            for (var i = 0; i < $('.precio').length; i++) {
                var d = $('.precio')[i];
                total = total + parseInt(d.innerHTML);
            }
            $('#total').html(total);
        }
    }
    function setPrecioEstudio(precio) {
        precioactual = precio;
    }
    function Guardar() {
        estudios = [];
        for (var i = 0; i < $('.estudio').length; i++) {
            var d = $('.estudio')[i].getAttribute("clave")
            estudios.push(d);
        }
        if ($("#PacientesNuevo option:selected").text() != "") {
            if (confirm("¿Deseas guardar la solicitud del paciente " + $("#PacientesNuevo option:selected").text())) {
                if ($('#paciente').val() != "" && estudios.length > 0) {
                    $.ajax({
                        type: "POST",
                        dataType: 'json',
                        data: {
                            PaseMedico: $('#pase').val(), Observaciones: $('#indicaciones').val(), Paciente: parseInt($('#PacientesNuevo').val()),
                            Medico: parseInt($('#Medicos').val()), Empresa: parseInt($('#Empresas').val()), Estudios: estudios,
                            Urgencia: parseInt($('#Urgencia').val()), ObservacionesUrgencia: $('#observaciones').val(), Factura: parseInt($('#factura').val()), DatosFactura: $('#datosfactura').val()
                        },
                        url: '@Url.Content("~/")Estudios/CrearSolicitudEstudio',
                        async: true,
                        success: function (response) {
                            estudios = [];
                            alert('Solicitud ingresada con exito');
                            //window.open('@Url.Content("~/")Estudios/Solicitud/' + response.Resultado, '_blank');
                            window.location.replace('@Url.Content("~/")Estudios/DetalleSolicitud/' + response.Resultado);
                        }
                    })
                }
                else {
                    alert("La solicitud debe tener un paciente y estudios registrados.")
                }
            } else {

            }
        }
        else {
            alert("La solicitud debe tener un paciente y estudios registrados.")}
    }

    function EliminarEstudio(id) {
        var tr = $("#tr" + id);
        tr.remove();
        var total = 0;
        for (var i = 0; i < $('.precio').length; i++) {
            var d = $('.precio')[i];
            total = total + parseInt(d.innerHTML);
        }
        $('#total').html(total);
    }
    $(document).ready(function () {
        estudios = [];
         SearchPaciente();
         SearchEstudio();
         $('#txtMedico').val("a quien corresponda");
         SearchTextMedico();
         $('#Empresas').val(1);
    });
      function SearchPaciente() {
        if ($('#textPaciente').val().length > 4) {
            $.ajax({
                type: "POST",
                dataType: 'json',
                data: {
                    Nombre: $('#textPaciente').val()
                },
                url: '@Url.Content("~/")Estudios/GetPacientes',
                async: true,
                success: function (response) {
                    ddl1.empty();
                    $(response).each(function () {
                        debugger;
                        var date = new Date(parseInt(this.FechaNacimiento.replace("/Date(", "").replace(")/", ""), 10));
                        var day = date.getDate()+1;
                        var monthIndex = date.getMonth()+1;
                        var year = date.getFullYear();
                        var d = new Date(this.FechaNacimiento.match(/\d+/)[0] * 1);
                        let formatted_date = d.getDate() + "/" + (d.getMonth() + 1) + "/" + d.getFullYear()
                        console.log(formatted_date)
                        $(document.createElement('option'))
                            .attr({ 'value': this.Id })
                            .text(this.NombreCompleto + " - " + this.NumeroSeguroSocial+ " - " + this.Direccion)
                            .appendTo(ddl1);
                    });
                    ddl1.focus();
                }
            })
        }

    }
      function expand(obj) {
          obj.size = 5;
      }
      function unexpand(obj) {
          obj.size = 1;
      }
    function SearchTextMedico() {
        if ($('#txtMedico').val().length > 3) {
            $.ajax({
                type: "POST",
                dataType: 'json',
                data: {
                    Nombre: $('#txtMedico').val()
                },
                url: '@Url.Content("~/")Estudios/GetMedicos',
                async: true,
                success: function (response) {
                    ddl2.empty();
                    $(response).each(function () {
                        $(document.createElement('option'))
                            .attr({ 'value': this.Id })
                            .text(this.NombreCompleto)
                            .appendTo(ddl2);
                    });
                    ddl2.click();
                }
            })
        }
      }
    function SearchEstudio() {
        if ($('#txtEstudio').val().length > 2) {
            $.ajax({
                type: "POST",
                dataType: 'json',
                data: {
                    Nombre: $('#txtEstudio').val()
                },
                url: '@Url.Content("~/")Estudios/GetEstudios',
                async: true,
                success: function (response) {
                    ddl3.empty();
                    $(response).each(function () {
                        $(document.createElement('option'))
                            .attr({ 'value': this.ClaveEstudio, 'precio': this.PrecioBase })
                            .text(this.Nombre)
                            .appendTo(ddl3);
                    });
                    ddl3.focus();
                    ddl3.change();
                }
            })
        }
    }

</script>